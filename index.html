<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Official Civic Portal for reporting local issues. A Government of India initiative.">
<title>Civic Portal | Government of India</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
    --primary-blue: #0d47a1;
    --light-blue: #1e88e5;
    --dark-text: #333333;
    --light-bg: #f0f2f5;
    --white: #ffffff;
    --grey-border: #ced4da;
    --grey-bg: #f8f9fa;
   
    /* Dynamic theme variables */
    --main-bg: var(--light-bg);
    --card-bg: var(--white);
    --text-color: var(--dark-text);
    --card-border: #dee2e6;
    --input-bg: var(--grey-bg);
    --input-border: var(--grey-border);
}

.dark-theme {
    --main-bg: #121212;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --card-border: #333333;
    --input-bg: #2b2b2b;
    --input-border: #444444;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
    font-family:'Poppins', sans-serif;
    background-color: var(--main-bg);
    color: var(--text-color);
    line-height:1.6;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}
.skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--primary-blue);
    color: white;
    padding: 8px;
    z-index: 1000;
    transition: top 0.3s;
}
.skip-link:focus {
    top: 0;
}

/* --- Header --- */
header {
    background: var(--card-bg);
    padding: 12px 24px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 3px solid var(--primary-blue);
}

.header-right-controls {
    display: flex;
    align-items: center;
    gap: 25px;
}

.header-ashoka-emblem {
    height: 50px;
    width: auto;
}

.logo-container{display:flex;align-items:center;gap:15px}
.logo-container .emblem{height:50px;width:auto}
.title-container h1{font-size:24px;color: var(--primary-blue);font-weight:700; margin:0;}
.title-container p{font-size: 14px; color: var(--text-color); margin:0;}

/* --- Main Content --- */
main {
    flex-grow: 1;
    width: 100%;
}
.card{
    max-width:820px;
    margin:24px auto;
    padding:24px;
    border-radius:8px;
    background:var(--card-bg);
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    border:1px solid var(--card-border);
}
input,select,textarea,button{width:100%;padding:12px;border-radius:6px;border:1px solid var(--input-border);margin-top:10px;background:var(--input-bg);color:var(--text-color);font-size:15px;font-family:'Poppins',sans-serif}
input:focus,select:focus,textarea:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
.btn{background-color:var(--light-blue);color:var(--white);cursor:pointer;font-weight:600;border:none;transition:background-color 0.2s ease}
.btn:hover{background-color:var(--primary-blue)}
.btn-danger{background:#dc3545}
.btn-danger:hover{background:#c82333}
.small{font-size:13px;color:#6c757d;margin-top:8px}
.hidden{display:none}
.upload-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
.preview{margin-top:8px}
img,video,audio{max-width:100%;border-radius:8px}
.controls{display:flex;gap:10px;margin-top:8px}
.reports-list > .report{margin-top:16px;padding:16px;border-radius:8px;background:var(--input-bg);border:1px solid var(--card-border); position:relative;}
.error{color:#dc3545;font-size:14px;margin-top:8px}
.success{color:#28a745;font-size:14px;margin-top:8px}
a{color:var(--light-blue); text-decoration: none;}
a:hover{text-decoration: underline;}
.password-container{position:relative}
.password-toggle-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-color);cursor:pointer;font-size:1.2rem;padding:0;margin:0}
#languageSelector{background:var(--card-bg);color:var(--text-color);border:1px solid var(--card-border);width:auto;flex-grow:1;margin-top:0;padding:8px 12px}
#languageSelector option{background:var(--card-bg);color:var(--text-color)}

/* --- Footer --- */
.site-footer {
    background-color: #1e1e1e;
    color: #ecf0f1;
    padding: 30px 0;
    font-size: 14px;
}
.footer-column h3 { color: var(--white); }
.footer-bottom { background-color: #121212; }
.footer-column ul li a { color: #ecf0f1; }
.footer-container {
    max-width: 1100px;
    margin: auto;
    padding: 0 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 20px;
}
.footer-column { flex: 1; min-width: 220px; }
.footer-column h3 { font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #7f8c8d; padding-bottom: 8px; }
.footer-column ul { list-style: none; padding: 0; }
.footer-column ul li { margin-bottom: 10px; }
.footer-column ul li a:hover { color: #3498db; }
.footer-bottom {
    text-align: center;
    padding: 15px 20px;
    background-color: #233140;
    margin-top: 20px;
    font-size: 13px;
}
.footer-logos { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }
.footer-logos img { height: 40px; }

.map-container {
    height: 300px;
    margin-top: 15px;
    border-radius: 8px;
    border: 1px solid var(--grey-border);
    z-index: 0;
}

@media(max-width:768px){
    header{flex-direction: column; gap: 10px;}
    .title-container h1{font-size:20px}
    .logo-container .emblem{height:40px}
    .footer-container { flex-direction: column; }
    .card{margin:12px;padding:16px}
}

.status-message {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
.status-message.show {
    opacity: 1;
}
.status-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.priority-tag {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 700;
    border-radius: 4px;
    color: white;
}
.priority-tag.high { background-color: #dc3545; }
.priority-tag.medium { background-color: #ffc107; }
.priority-tag.low { background-color: #17a2b8; }
/* --- Modal Styles --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none; /* Hidden by default */
    justify-content: center;
    align-items: center;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.visible {
    display: flex;
    opacity: 1;
}

.modal-content {
    background: var(--card-bg);
    color: var(--text-color);
    padding: 25px 30px;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transform: translateY(-50px);
    transition: transform 0.3s ease;
}

.modal-overlay.visible .modal-content {
    transform: translateY(0);
}

.modal-close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-color);
    cursor: pointer;
    line-height: 1;
    padding: 0;
    margin: 0;
    width: auto;
}
</style>
</head>

<body>
<a href="#main-content" class="skip-link">Skip to Main Content</a>

<header>
    <div class="logo-container">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI4MiIgdmlld0JveD0iMCAwIDUwIDgyIj48ZyBmaWxsPSIjMGQ0N2ExIj48cGF0aCBkPSJNMjUgMGMtNSAwLTkgMy0xMSA3LTQgNS0yIDgtMiAxMCAyIDMgNSA2IDExIDYgNiAwIDktMyAxMS02IDItMiAyLTUgMC0xMC0yLTQtNi03LTExLTd6bTAgMmM0IDAgNyAzIDkgNnMyIDYgMCA4LTMgNS05IDVzLTctMi05LTVjMC0yLTMtNi0xLThzNS02IDktNnoiLz48cGF0aCBkPSJNMwozNGMxLTIgMy0zIDUtMyAyIDAgMyAxIDQgMmwxIDRjMCAxLTEgNC0xIDYtMSAwLTEtMS0yLTItMSAwLTIgMC0yIDItMiAzLTUgNC03IDQtMyAwLTUtMi01LTUgMC0zIDItNSA0LTZ6bTQ0IDBjMS0yIDMtMyA1LTMgMiAwIDMgMSA0IDJsMSA0YzAgMS0xIDQtMSA2LTEgMC0xLTEtMi0yLTEgMC0yIDAtMiAyLTIgMy01IDQtNyA0LTMgMC01LTItNS01IDAtMyAyLTUgNC02eiIvPjxwYXRoIGQ9Ik0yNSAzM2MtNCAwLTcgMy03IDYgMCAxIDAgMyAyIDYgMSAyIDIgMyAyIDYgMCAyIDAgMy0xIDQgMCAxIDAgMSA1IDIxIDUgMy05IDMgOC0zIDQtNS00LTggMC0yIDAtMy0xLTQgMC0zLTEtNC0yLTYtMi0zLTUtNy03LTZ6bTAgMmMzIDAgNSAyIDUgNGMwIDEtMS0yLTEtNC0xLTEtMS0xLTItMi0xLTEtMS0xLTItMi0xLTItMS0zLTEtNS0xLTEgMC0yIDIgMiAyIDAgMC0xIDAtMiAxLTEgMSAwIDIgMS0yeiIvPjxwYXRoIGQ9Ik0yNSA1OWMtNiAwLTkgMi05IDYgMCAzIDIgNiA5IDYgNiAwIDktMyA5LTYgMC00LTMtNi05LTZ6bTAgMmM0IDAgNyAyIDcgNCAwIDItMSA0LTcgNC02IDAtNy0yLTctNCAwLTIgMy00IDctNHoiLz48cGF0aCBkPSJNMTEgNzRjMC0xIDAtMS0xLTItMy02LTMtMTAgMC0xMyAzLTMgNy0zIDExIDAgNC0zIDgtNiAxMy0zIDQgMCA4IDIgMTEgMyAzIDMgNiA3IDYgMTAtNC0zLTgtNS0xMy01aC0xYy01IDAtOS0yLTEzIDV6Ii8+PHBhdGggZD0iTTI1IDc4YzEgMCAxIDAgMiAwIDAgMCAxIDAgMS0xIDItMiAxLTQgMSA1LTAtMS0xLTIgMC0yLTItMS0xLTEtMi0yLTJ6Ii8+PC9nPjwvc3ZnPg==" alt="Emblem of India" class="emblem" />
        <div class="title-container">
            <h1><span data-lang="portalTitle">Civic Portal</span></h1>
            <p>Government of India</p>
        </div>
    </div>

    <div class="header-right-controls">
        <div style="max-width: 150px;">
            <select id="languageSelector" onchange="setLanguage(this.value)">
                <option value="en">English</option>
                <option value="hi">हिन्दी</option>
                <option value="mr">मराठी</option>
                <option value="or">ଓଡ଼ିଆ</option>
                <option value="ur">اردو</option>
            </select>
        </div>
        <button id="themeToggle" class="btn" onclick="toggleTheme()" aria-label="Toggle dark/light theme" style="width: auto; margin-top: 0;">☀️</button>
        <img src="https://www.nicepng.com/png/detail/933-9333810_ashok-stambh-logo-hd.png" alt="Ashoka Stambha" class="header-ashoka-emblem" />
    </div>
</header>
<div id="statusMessage" class="status-message hidden" role="status"></div>
<main id="main-content">
    <div id="page0" class="card">
        <h2 data-lang="roleQuestion"> Who are you?</h2>
        <p class="small" data-lang="roleInstruction">Choose role to continue</p>
        <div style="display:flex;gap:12px;margin-top:16px">
            <button class="btn" onclick="gotoPage('userLogin')" data-lang="userButton">I am a User</button>
            <button class="btn" onclick="gotoPage('fieldStaffLogin')" data-lang="fieldStaffButton">I am Field Staff</button>
            <button class="btn" onclick="gotoPage('adminLogin')" data-lang="adminButton">I am an Admin</button>
        </div>
    </div>

    <div id="userLogin" class="card hidden">
        <h2 data-lang="userLoginTitle"> Sign in with Google</h2>
        <div id="g_id_onload"
        data-client_id="206870259193-04tn3lhqmn4sf61cmp7l0pmgntafclnf.apps.googleusercontent.com"
        data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
        <p class="small" data-lang="userLoginInstruction">After signing in you'll be taken to the user portal</p>
        <p class="small"><a href="#" onclick="gotoPage('page0')" data-lang="backButton">← Back</a></p>
    </div>

    <div id="adminLogin" class="card hidden">
        <h2 data-lang="adminLoginTitle"> Admin Login</h2>
        <input id="adminId" placeholder="Admin ID " data-lang-placeholder="adminIdPlaceholder">
        <div class="password-container">
          <input id="adminPass" placeholder="Password " type="password" data-lang-placeholder="adminPassPlaceholder">
          <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('adminPass')" aria-label="Toggle password visibility">👁</button>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" onclick="adminLogin()" data-lang="loginButton">Login</button>
        <button class="btn" onclick="gotoPage('page0')" style="background-color:#6c757d;" data-lang="cancelButton">Cancel</button>
        </div>
        <p id="adminError" class="error hidden" data-lang="adminLoginError"> Incorrect ID or Password</p>
    </div>

    <div id="fieldStaffLogin" class="card hidden">
        <h2 data-lang="fieldStaffLoginTitle">Field Staff Login</h2>
        <input id="fieldStaffId" placeholder="Field Staff ID" type="text" data-lang-placeholder="fieldStaffIdPlaceholder">
        <div class="password-container">
          <input id="fieldStaffPass" placeholder="Password" type="password" data-lang-placeholder="fieldStaffPassPlaceholder">
          <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('fieldStaffPass')" aria-label="Toggle password visibility">👁</button>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn" onclick="fieldStaffLogin()" data-lang="loginButton">Login</button>
            <button class="btn" onclick="gotoPage('page0')" style="background-color:#6c757d;" data-lang="cancelButton">Cancel</button>
        </div>
        <p id="fieldStaffError" class="error hidden" data-lang="adminLoginError">Incorrect ID or Password</p>
    </div>

    <div id="page3" class="card hidden">
        <h2 data-lang="reportIssueTitle"> Report an Issue</h2>
        <button id="voiceInputBtn" type="button" class="btn" onclick="toggleVoiceRecognition()" style="width: auto; margin-bottom: 5px;">🎤 Start Voice Input</button>
        <p id="voiceStatus" class="small" style="margin: 0 0 10px 5px;"></p>
        <textarea id="issueDesc" placeholder="Describe the issue..." rows="3" data-lang-placeholder="issueDescPlaceholder" onblur="autoCategorizeIssue()"></textarea>
        <select id="issueCat">
        <option value="" data-lang="selectCategoryPlaceholder">Select category</option>
        <option value="Electricity" data-lang="catElectricity">Electricity</option>
        <option value="Water" data-lang="catWater">Water</option>
        <option value="Streetlight" data-lang="catStreetlight">Streetlight</option>
        <option value="Road" data-lang="catRoad">Road</option>
        <option value="Sanitation" data-lang="catSanitation">Sanitation</option>
        </select>

       
        <div style="margin-top:12px">
            <label class="small" for="locationSearch">Find location by address</label>
            <input id="locationSearch" placeholder="Search for a location..." type="text">
            <button class="btn" onclick="searchLocation()" style="margin-top:0; width: auto;" data-lang="searchLocationBtn">Search</button>
            <label class="small" data-lang="locationLabel">Problem location</label>
           <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
    <input id="locationTxt" placeholder="Paste lat,lng or pin on map" data-lang-placeholder="locationPlaceholder" onblur="updateMapFromManualInput()" style="margin-top:0;">
    <button type="button" class="btn btn-danger" onclick="clearLocation()" style="width: auto; margin-top:0; flex-shrink: 0;">Clear</button>
</div>
            <div id="map-picker" class="map-container"></div>
        </div>

        <div style="margin-top:12px">
        <label class="small" data-lang="imageLabel"> Image (upload or capture)</label>
        <div class="upload-row">
        <input id="imgUpload" type="file" accept="image/*" capture="environment">
        <button class="btn" id="startCamBtn" type="button" data-lang="startCamBtn">Start Camera</button>
        <button class="btn btn-danger hidden" id="removeImgBtn" type="button" data-lang="removeImageBtn">Remove Image</button>
        </div>
        <video id="imgVideo" class="hidden preview" autoplay playsinline style="max-height:300px"></video>
        <div class="controls hidden" id="imgCamControls">
        <button class="btn" id="takePhotoBtn" type="button" data-lang="takePhotoBtn">Take Photo</button>
        <button class="btn" id="stopCamBtn" type="button" data-lang="stopCamBtn">Stop Camera</button>
        </div>
        <canvas id="imgCanvas" class="hidden"></canvas>
        <img id="imgPreview" class="hidden preview" alt="image preview">
        </div>

        <div style="margin-top:14px">
        <label class="small" data-lang="videoLabel"> Video (upload or record)</label>
        <div class="upload-row">
        <input id="vidUpload" type="file" accept="video/*" capture="camcorder">
        <button class="btn" id="startVidRec" type="button" data-lang="startVidRec">Start Recording</button>
        <button class="btn hidden" id="stopVidRec" type="button" data-lang="stopVidRec">Stop Recording</button>
        <button class="btn btn-danger hidden" id="removeVidBtn" type="button" data-lang="removeVidBtn">Remove Video</button>
        </div>
        <video id="vidPreview" class="hidden preview" controls style="max-height:300px"></video>
        </div>

        <div style="margin-top:14px">
        <label class="small" data-lang="audioLabel"> Audio (upload or record)</label>
        <div class="upload-row">
        <input id="audUpload" type="file" accept="audio/*" capture="microphone">
        <button class="btn" id="startAudRec" type="button" data-lang="startAudRec">Start Recording</button>
        <button class="btn hidden" id="stopAudRec" type="button" data-lang="stopAudRec">Stop Recording</button>
        <button class="btn btn-danger hidden" id="removeAudBtn" type="button" data-lang="removeAudBtn">Remove Audio</button>
        </div>
        <audio id="audPreview" class="hidden preview" controls></audio>
        </div>

        <div style="display:flex;gap:12px;margin-top:16px">
        <button class="btn" onclick="submitReport()" data-lang="submitReportBtn">Submit Report</button>
        <button class="btn" onclick="logoutUser()" style="background-color:#6c757d;" data-lang="logoutBtn">Logout</button>
        </div>
        <h3 style="margin-top:24px; border-top: 1px solid #e9ecef; padding-top: 16px;" data-lang="myReportsTitle"> My Reports</h3>
        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
            <label for="sortUserReports">Sort by:</label>
            <select id="sortUserReports" onchange="renderUserReports()">
                <option value="dateDesc" data-lang="sortNewest">Newest</option>
                <option value="dateAsc" data-lang="sortOldest">Oldest</option>
                <option value="status" data-lang="sortStatus">Status</option>
                <option value="category" data-lang="sortCategory">Category</option>
            </select>
        </div>
        <div id="userReports" class="reports-list"></div>
    </div>

    <div id="page4" class="card hidden">
        <h2 data-lang="adminDashboardTitle"> Admin Dashboard</h2>
        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
            <label for="sortAdminReports">Sort by:</label>
            <select id="sortAdminReports" onchange="renderAllReports()">
                <option value="priority" data-lang="sortPriority">Priority</option>
                <option value="dateDesc" data-lang="sortNewest">Newest</option>
                <option value="status" data-lang="sortStatus">Status</option>
                <option value="category" data-lang="sortCategory">Category</option>
            </select>
            <label for="filterAdminReports">Filter by:</label>
            <select id="filterAdminReports" onchange="renderAllReports()">
                <option value="all" data-lang="filterAll">All</option>
                <option value="Submitted" data-lang="statusSubmitted">Submitted</option>
                <option value="Accepted" data-lang="statusAccepted">Accepted</option>
                <option value="In Progress" data-lang="statusInProgress">In Progress</option>
                <option value="Resolved" data-lang="statusResolved">Resolved</option>
            </select>
            <button class="btn" onclick="speakReportSummary()" style="width: auto; margin-top:0;">🔊 Read Summary</button>
            <button class="btn btn-danger" onclick="stopSpeaking()" style="width: auto; margin-top:0;">🛑 Stop</button>
        </div>
        <div id="allReports" class="reports-list"></div>
        <h3 style="margin-top:24px; border-top: 1px solid #e9ecef; padding-top: 16px;" data-lang="analyticsTitle"> Analytics</h3>
        <canvas id="statusChart" style="margin-top:8px"></canvas>
        <div style="margin-top:12px">
        <button class="btn" onclick="gotoPage('page0')" style="background-color:#6c757d;" data-lang="backToRoleBtn">Back to Role Select</button>
        </div>
    </div>

    <div id="fieldStaffDashboard" class="card hidden">
        <h2 data-lang="fieldStaffDashboardTitle">Field Staff Dashboard</h2>
        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
            <label for="workTypeSelector" data-lang="workTypeLabel">My Work Type:</label>
            <select id="workTypeSelector" onchange="renderFieldStaffDashboard()" style="width: auto; flex-grow: 1;">
                <option value="Electricity" data-lang="catElectricity">Electricity</option>
                <option value="Water" data-lang="catWater">Water</option>
                <option value="Streetlight" data-lang="catStreetlight">Streetlight</option>
                <option value="Road" data-lang="catRoad">Road</option>
                <option value="Sanitation" data-lang="catSanitation">Sanitation</option>
            </select>
            <button class="btn" onclick="logoutUser()" style="background-color:#6c757d; width: auto; margin-top: 0;" data-lang="logoutBtn">Logout</button>
        </div>
        <h3 style="margin-top:24px; border-top: 1px solid var(--card-border); padding-top: 16px;" data-lang="availableJobsTitle">Available Jobs</h3>
        <div id="availableJobsList" class="reports-list"></div>
        <h3 style="margin-top:24px; border-top: 1px solid var(--card-border); padding-top: 16px;" data-lang="assignedJobsTitle">My Assigned Jobs</h3>
        <div id="assignedJobsList" class="reports-list"></div>
    </div>
</main>

<div id="quickLinkModal" class="modal-overlay" onclick="closeQuickLinkModal()">
    <div class="modal-content" onclick="event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <button class="modal-close-btn" onclick="closeQuickLinkModal()" aria-label="Close dialog">&times;</button>
        <h2 id="modalTitle"></h2>
        <div id="modalBody"></div>
    </div>
</div>
<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-column">
            <h3>Quick Links</h3>
            <ul>
                <li><a href="javascript:void(0);" onclick="showQuickLinkModal('about')">About Us</a></li>
                <li><a href="javascript:void(0);" onclick="showQuickLinkModal('policies')">Website Policies</a></li>
                <li><a href="javascript:void(0);" onclick="showQuickLinkModal('help')">Help</a></li>
                <li><a href="javascript:void(0);" onclick="showQuickLinkModal('contact')">Contact Us</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Resources</h3>
            <ul>
                <li><a href="https://www.mygov.in" target="_blank" rel="noopener noreferrer">MyGov</a></li>
                <li><a href="https://pgportal.gov.in" target="_blank" rel="noopener noreferrer">CPGRAMS</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Contact Info</h3>
            <p>Office of Civic Affairs<br>Bhubaneswar, Odisha, India<br>Email: <a href="mailto:contact@civicportal.gov.in">contact@civicportal.gov.in</a></p>
        </div>
    </div>
    <div class="footer-bottom">
        <p>This website is designed, developed and maintained by National Informatics Centre (NIC).</p>
        <div class="footer-logos">
            <a href="https://www.digitalindia.gov.in" target="_blank" rel="noopener noreferrer"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMzguMyA5My40Ij48cGF0aCBmaWxsPSIjRjY4QjFGIiBkPSJNMCAwaDMzOC4z insensibleIMzguM3oiLz48cGF0aCBmaWxsPSIjRkZGIiBkPSJNMzguMSA3My40aDQuN3Y5LjZoLTQuN3ptNiA5LjloLjctLjVjMC0xLS4zLTItLjYtMi41LS40LS41LTEtLjctMi0uNy0uNyAwLTEuMy4zLTItLjgxLTEgMC0uNiAxLjQtLjYgMi40djEwLjNoLTQuN3YtMjUuMWg0Ljd2MS4zYzEtMS4xIDEuNC0xLjYgMi43LTEuNiAxLjYgMCAyLjguNiAzLjcgMi4xIDEgMS4zIDEuNiAzIDEuNiA1LjR2OS42em05LjEtOS45bC0xMi45IDguNyA2LjUtOS45aDQuOGwtNS4yIDguNiA1LjUgMTEuNGgtNS4xbC0zLjQtNy45LTMuNiA3LjloLTUuMWw3LjEtMTIuOHpNMzYuOSA5My40aDQuN3YtNDAuMmg0LjdsMjMuNCAzMC4zaC03LjlsLTE2LjktMjUuMyAyNC45LTI3LjdoLTQuN3Y0MC4yaC00Ljd2LTMwLjJoLTIzLjQtMzAuM2g3LjlsMTYuOSAyNS4zLTI0LjkgMjcuN3ptNDIgMS44aDUuM2w1LjgtMTEuNSA1LjggMTEuNWg1LjNsLTguMy0xNS4xIDguNC0xNS45aC01LjNsLTUuNiAxMC41LTUuNy0xMC41aC01LjNsOC4yIDE1LjktOC4zIDE1LjF6bTI3LjctNi4yYzAtMS0uMy0yLjItLjgtMy0uNS0xLTEuMy0xLjgtMi41LTIuNy0xLjEtMS0yLjItMS4xLTMuNS0xLjEtMS40IDAtMi42LjQtMy41IDEuMS0xLjEtMS0xLjgtMi41LTIuNy0xLjYtMS0uOC0xLjEtMi4yLTEuMS0zLjRzLjMtMi4yLjgxLTMuNGMuNS0xIDEuMy0xLjggMi41LTIuNyAxLjEtMSAyLjItMS4xIDMuNS0xLjEgMS40IDAgMi42LjQgMy41IDEuMSAxIC44IDEuNyAyLjEgMS43IDMuNnptLTQuMy0uMmMwLTIuMy0uMi0zLjktLjctNC44LS41LS45LTEuMi0xLjYtMi0xLjYtLjggMC0xLjUuNy0yIDEuNi0uNS45LS43IDIuNS0uNyA0LjggMCAyLjMuMiAzLjkuNyA0LjhzMS4yIDEuNiAyIDEuNmMuOCAwIDEuNS0uNyAyLTEuNi41LS45LjctMi41LjctNC44em0xNi45IDYuMnYtMjUuMWg0Lj and vMjUuMWgtNC4ym03LjItNS4zdjguOGg0LjR2LTIuNWgtNC40Vjc2aC00LjhsLTgtMTMuNnYtMTIuOWg0Ljd2MTNoNC42eiIvPjwvc3ZnPg==" alt="Digital India Logo"></a>
            <a href="https://www.nic.in" target="_blank" rel="noopener noreferrer"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMTguMSAzMi45Ij48cGF0aCBmaWxsPSJ3aGl0ZSIgZD0iTTIwLjMgMzAuNGg5LjZWMTAuM2gtOS42djIwLjF6TTM2LjUgMjQuOWMwIDUuMi00IDkuMy04LjcgOS4zLTQuOSAwLTguNy00LjEtOC43LTkuM1Y2LjljMC01LjIgNC05LjMgOC43LTkuMyA0LjkgMCA4LjcgNC4xIDguNyA5LjN2MTh6bS0yNi42IDUuNWg5LjZWMTAuM2gtOS42djIwLjF6TTk4LjggMTguMWwtMS43LTQuOGMtLjEtLjMtLjEtLjUtLjEtLjdoLS4xYzAtLjEtLjEtLjMtLjEtLjVsLTYuOC0xNy4JIMzcuNFYxMGg5LjZWMi41aDEwLjF2Ny41aDkuNnYyMC4xaC05LjZ2LTguM2gtMTAuMXY4LjNoLTkuNnYtMjAuMWg5LjZ2Ny41aDEwLjFWMi41aDQuNVYxMGg5LjZWMi41aDkuN3Y3LjVoOS42VjMwLjRoLTkuNnYtNy41aC05LjZWMzAuNEgzNi41VjEwLjNoOS42VjIuNWgxMC4xdjcuNWg5LjZ2MjAuMWgtOS42di03LjVoLTEwLjF2Ny41aC05LjZ2LTIwLjFoOS42djguM2gxMC4xVjIuNWg5LjZWMTAuMGg5LjZWMzAuNGgtOS42di04LjNoLTEwLjF2OC4zaC05LjZWMTAuM2g5LjZWMi41aDkuOHY3LjVoOS42djIwLjFoLTkuNnYtNy41aC05Ljd2Ny41aC05LjZWMTAuM2g5LjZ2Ny41aDEwLjFWMi41aDEyLjJsOC42IDIxLjloLS4xbC0uMi0uMi0uMS4xLTMuOSAxMS4yaC05Ljd6Ii8+PC9zdmc+" alt="NIC Logo"></a>
        </div>
        <p id="lastUpdated" style="margin-top: 10px;">Page last updated on: </p>
    </div>
</footer>



<script>
// Add this line at the top of your script to update the footer date
document.addEventListener('DOMContentLoaded', function() {
    const date = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    document.getElementById('lastUpdated').textContent += date.toLocaleDateString('en-IN', options) + ' (IST)';
});

// --------------------- SUPABASE CONFIG: REPLACE THESE ---------------------
const SUPABASE_URL = 'https://gvdfqcljvkkisnvoubkw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2ZGZxY2xqdmtraXNudm91Ymt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NzM2ODQsImV4cCI6MjA3MzA0OTY4NH0.accgwK0kOLpq1AD6NqraDNSAyxrLwCoxyxfMBJAacIk';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --------------------- Improved Map Initialization ---------------------
let reportMap = null;
let marker = null;
let selectedCoords = null;
let mapInitialized = false;

function initializeReportMap() {
    if (mapInitialized) {
        reportMap.invalidateSize();
        return;
    }
   
    reportMap = L.map('map-picker').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(reportMap);

    marker = L.marker([20.5937, 78.9629], { draggable: true }).addTo(reportMap);
    marker.bindPopup("Drag me to the problem location, or click on the map.").openPopup();

    reportMap.on('click', function(e) {
        selectedCoords = e.latlng;
        marker.setLatLng(selectedCoords);
        marker.getPopup().setContent(`Location selected at: ${selectedCoords.lat.toFixed(4)}, ${selectedCoords.lng.toFixed(4)}`).openOn(reportMap);
        updateLocationFromCoords(selectedCoords);
    });
   
    marker.on('dragend', function(event){
        selectedCoords = event.target.getLatLng();
        marker.setLatLng(selectedCoords);
        marker.getPopup().setContent(`Location selected at: ${selectedCoords.lat.toFixed(4)}, ${selectedCoords.lng.toFixed(4)}`).openOn(reportMap);
        updateLocationFromCoords(selectedCoords);
    });
    mapInitialized = true;
}

// --------------------- New Geocoding Search Function ---------------------
async function searchLocation() {
    const query = document.getElementById('locationSearch').value.trim();
    if (!query) {
        showStatusMessage("Please enter a location to search.", 'error');
        return;
    }
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=IN&limit=1`);
        const data = await response.json();
        if (data && data.length > 0) {
            const result = data[0];
            const latlng = [parseFloat(result.lat), parseFloat(result.lon)];
            selectedCoords = L.latLng(latlng[0], latlng[1]);
            marker.setLatLng(selectedCoords);
            reportMap.setView(selectedCoords, 16);
            updateLocationFromCoords(selectedCoords, result.display_name);
            showStatusMessage("Location found and pinned on the map.", 'success');
        } else {
            showStatusMessage("No location found. Try a different search term.", 'error');
        }
    } catch (e) {
        showStatusMessage("Search failed. Please try again.", 'error');
        console.error("Geocoding search failed:", e);
    }
}
// DELETE your old updateLocationFromCoords function and REPLACE it with this one.
async function updateLocationFromCoords(coords, address = null) {
    if (address) {
        document.getElementById('locationTxt').value = address;
        return;
    }

    // Show immediate feedback to the user
    document.getElementById('locationTxt').value = 'Fetching address...';

    try {
        // This is the reverse geocoding API call
        const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data && data.display_name) {
            // If the API finds an address, display it
            document.getElementById('locationTxt').value = data.display_name;
            showStatusMessage('Address found!', 'success');
        } else {
            // If no address is found, fall back to showing coordinates
            throw new Error('No address found for these coordinates.');
        }
    } catch (e) {
        console.error("Reverse geocoding failed:", e);
        // On failure, display the coordinates so the user still has the location data
        document.getElementById('locationTxt').value = `${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`;
        showStatusMessage('Could not fetch address, showing coordinates instead.', 'error');
    }
}

function clearLocation() {
    // Clear the text input
    document.getElementById('locationTxt').value = '';

    // Reset the global coordinate variable
    selectedCoords = null;

    // Reset the map to its default, zoomed-out view
    const defaultCoords = [20.5937, 78.9629];
    marker.setLatLng(defaultCoords);
    reportMap.setView(defaultCoords, 5);

    showStatusMessage('Location cleared.', 'success');
}

// --------------------- Helpers ---------------------
function dataURLtoFile(dataurl, filename) {
  const arr = dataurl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--) u8arr[n] = bstr.charCodeAt(n);
  return new File([u8arr], filename, { type: mime });
}

async function uploadFileToBucket(path, file) {
  const { data, error } = await supabaseClient.storage.from('reports').upload(path, file, { upsert: false });
  if (error) throw error;
  return data;
}

async function getSignedUrlForPath(path, expires = 60 * 60) {
  const { data, error } = await supabaseClient.storage.from('reports').createSignedUrl(path, expires);
  if (error) throw error;
  return data?.signedUrl || null;
}

function getPublicUrlForPath(path) {
  const { data } = supabaseClient.storage.from('reports').getPublicUrl(path);
  return data?.publicUrl || null;
}
// --------------------- AI Voice Summary Functions ---------------------
async function speakReportSummary() {
    // First, stop any speech that is currently happening
    stopSpeaking();

    if (!('speechSynthesis' in window)) {
        showStatusMessage('Sorry, your browser does not support text-to-speech.', 'error');
        return;
    }

    try {
        // Fetch the same data that the dashboard uses
        const filterBy = document.getElementById('filterAdminReports').value;
        let query = supabaseClient.from('reports').select('status, cat');
        if (filterBy !== 'all') {
            query = query.eq('status', filterBy);
        }
       
        const { data: rows, error } = await query;
        if (error) throw error;
       
        if (rows.length === 0) {
            const utterance = new SpeechSynthesisUtterance("There are no reports matching the current filter.");
            window.speechSynthesis.speak(utterance);
            return;
        }

        // Create a summary text
        const totalReports = rows.length;
        const categoryCounts = rows.reduce((acc, report) => {
            acc[report.cat] = (acc[report.cat] || 0) + 1;
            return acc;
        }, {});

        let summaryText = `There are ${totalReports} reports. `;
        if(filterBy !== 'all') {
            summaryText = `There are ${totalReports} reports with the status ${filterBy}. `;
        }
       
        summaryText += "The breakdown by category is as follows: ";
       
        for (const [category, count] of Object.entries(categoryCounts)) {
            summaryText += `${count} for ${category}, `;
        }

        // Create an utterance and speak it
        const utterance = new SpeechSynthesisUtterance(summaryText);
        utterance.lang = document.getElementById('languageSelector').value; // Optional: use selected language
        utterance.rate = 0.9; // A slightly slower rate is often clearer
        window.speechSynthesis.speak(utterance);

    } catch (e) {
        console.error("Could not fetch reports for voice summary:", e);
        const utterance = new SpeechSynthesisUtterance("I'm sorry, I was unable to retrieve the report data.");
        window.speechSynthesis.speak(utterance);
    }
}

function stopSpeaking() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
}
// --------------------- Speech Recognition (Voice-to-Text)---------------------
let recognition;
let isRecognizing = false;
const voiceInputBtn = document.getElementById('voiceInputBtn');
const voiceStatus = document.getElementById('voiceStatus');
const issueDescTextarea = document.getElementById('issueDesc');

// Check if the browser supports the Web Speech API
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
    voiceInputBtn.disabled = true;
    voiceStatus.textContent = "Sorry, your browser doesn't support voice input.";
} else {
    recognition = new SpeechRecognition();

    // Fired when speech is recognized
    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        // Append the new transcript to the existing text
        issueDescTextarea.value += (issueDescTextarea.value.length > 0 ? ' ' : '') + transcript + '.';
    };
   
    // Fired when recognition starts
    recognition.onstart = () => {
        isRecognizing = true;
        voiceStatus.textContent = "Listening... please speak now.";
        voiceInputBtn.innerHTML = "🛑 Stop Listening";
        voiceInputBtn.classList.add('btn-danger');
    };

    // Fired when recognition ends
    recognition.onend = () => {
        isRecognizing = false;
        voiceStatus.textContent = "";
        voiceInputBtn.innerHTML = "🎤 Start Voice Input";
        voiceInputBtn.classList.remove('btn-danger');
    };
   
    // Fired on error
    recognition.onerror = (event) => {
        if (event.error === 'not-allowed') {
            voiceStatus.textContent = "Error: Microphone access was denied.";
        } else {
            voiceStatus.textContent = "Error: " + event.error;
        }
    };
}

function toggleVoiceRecognition() {
    if (!SpeechRecognition) return;
   
    if (isRecognizing) {
        recognition.stop();
    } else {
        // Map language codes to specific dialects for better accuracy
        const langMap = {
            'en': 'en-IN', // English (India)
            'hi': 'hi-IN', // Hindi (India)
            'mr': 'mr-IN', // Marathi (India)
            'or': 'or-IN', // Oriya (India)
            'ur': 'ur-IN'  // Urdu (India)
        };
        const currentLang = document.getElementById('languageSelector').value;
        recognition.lang = langMap[currentLang] || 'en-IN';
       
        recognition.start();
    }
}
// --------------------- Quick Links Modal Logic ---------------------
const quickLinkModal = document.getElementById('quickLinkModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

const quickLinkContent = {
    about: {
        title: "About Us",
        body: `<h3>Welcome to the Civic Portal</h3>
                <p>This portal is a dedicated initiative for the citizens of Bhubaneswar, developed by <strong>Team Civic Sparks</strong> for the Government of India. It is designed and maintained by the National Informatics Centre (NIC).</p>
                <p>Our mission is to provide a modern, accessible, and efficient platform for residents to report local civic issues. By leveraging technology, including AI-powered categorization and voice input, we aim to bridge the gap between citizens and administration, ensuring that grievances related to sanitation, water logging, electricity, and other essential services are addressed transparently and promptly.</p>
                <p>© 2024 Civic Sparks. All Rights Reserved.</p>`
    },
    policies: {
        title: "Website Policies",
        body: `<h3>Privacy Policy</h3>
                <p>Your privacy is important to us. This policy explains how we handle and treat your data.</p>
                <ul>
                    <li><strong>Information Collection:</strong> We collect personal information (name, email via Google Sign-In) and report details (description, location, media files) solely for the purpose of addressing civic complaints.</li>
                    <li><strong>Use of Information:</strong> Your information is used to register, assign, and track complaints with the relevant municipal departments. We do not sell or rent personal data to third parties.</li>
                    <li><strong>Data Security:</strong> We use industry-standard security measures, including secure cloud storage via Supabase, to protect your data from unauthorized access.</li>
                </ul>
                <h3>Terms of Service</h3>
                <p>By using this portal, you agree to the following terms:</p>
                <ul>
                    <li>You will provide accurate and truthful information in your reports.</li>
                    <li>You will not submit content that is unlawful, obscene, defamatory, or otherwise objectionable.</li>
                    <li>Misuse of this platform for spam, false reports, or malicious activities may result in a temporary or permanent ban from our service.</li>
                </ul>`
    },
    help: {
        title: "Help & Support",
        body: `<h3>Getting Started</h3>
                <p>This site is designed to make reporting civic issues in Bhubaneswar as easy as possible.</p>
                <p><strong>Step 1: Choose Your Role</strong><br>Select "I am a User" to begin the reporting process.</p>
                <p><strong>Step 2: Sign In Securely</strong><br>Use your Google account for a quick and secure sign-in. We only use your email to identify your reports.</p>
                <p><strong>Step 3: Report an Issue</strong><br>
                    <ul>
                        <li><strong>Voice Input:</strong> Click the 🎤 button to describe the issue using your voice.</li>
                        <li><strong>Category:</strong> Our AI will try to select a category for you based on your description. You can also change it manually.</li>
                        <li><strong>Location:</strong> Pin the exact location on the map for a faster response from municipal teams.</li>
                        <li><strong>Proof:</strong> Upload images, video, or audio directly from your device to provide clear evidence.</li>
                    </ul>
                </p>
                <p><strong>Step 4: Track Your Reports</strong><br>All your submissions appear under the "My Reports" section, where you can see their current status (Submitted, In Progress, Resolved).</p>`
    },
    contact: {
        title: "Contact Us",
        body: `<h3>Get in Touch</h3>
                <p>For urgent issues or if you need to speak with a representative, please use the contact details below.</p>
                <p><strong>Civic Helpline Number (24/7):</strong><br>
                1800-180-1234</p>
                <p><strong>General Inquiries (Municipal Office):</strong><br>
                Email: <a href="mailto:contact@civicportal.gov.in">contact@civicportal.gov.in</a></p>
                <p><strong>Technical Support (Team Civic Sparks):</strong><br>
                Email: <a href="mailto:team.civicsparks@gmail.com">team.civicsparks@gmail.com</a></p>`
    }
};

function showQuickLinkModal(type) {
    if (quickLinkContent[type]) {
        modalTitle.textContent = quickLinkContent[type].title;
        modalBody.innerHTML = quickLinkContent[type].body;
        quickLinkModal.classList.add('visible');
    }
}

function closeQuickLinkModal() {
    quickLinkModal.classList.remove('visible');
}

// --------------------- AI Auto-Categorization Function ---------------------
async function autoCategorizeIssue() {
    const description = document.getElementById('issueDesc').value.trim();
    if (description.length < 10) return; // Don't run for very short descriptions

    // --- IMPORTANT: Replace with your actual API key ---
    const API_KEY = 'AIzaSyCEASQob96dMkeZO5HCzK8Xup65uhYAJ6Q';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;

    // The categories must match the 'value' attributes in your HTML select options
    const categories = ['Electricity', 'Water', 'Streetlight', 'Road', 'Sanitation'];

    const prompt = `Based on the following user complaint, classify it into one of these exact categories: ${categories.join(', ')}. Return only the single category name and nothing else. Complaint: "${description}"`;

    showStatusMessage('Analyzing description to suggest a category...', 'success');

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }

        const data = await response.json();
        const category = data.candidates[0].content.parts[0].text.trim();

        // Check if the AI returned a valid category
        if (categories.includes(category)) {
            document.getElementById('issueCat').value = category;
            showStatusMessage(`Suggested Category: ${category}`, 'success');
        } else {
             console.warn('AI returned an invalid category:', category);
        }

    } catch (error) {
        console.error('AI categorization failed:', error);
        showStatusMessage('Could not auto-suggest category.', 'error');
    }
}


// --------------------- Navigation ---------------------
// REPLACE IT WITH THIS NEW VERSION
function gotoPage(id) {
    // We've added the new pages to this list
    const pages = ['page0', 'userLogin', 'adminLogin', 'fieldStaffLogin', 'page3', 'page4', 'fieldStaffDashboard'];
    pages.forEach(p => {
        if (document.getElementById(p)) {
             document.getElementById(p).classList.add('hidden');
        }
    });
    document.getElementById(id).classList.remove('hidden');

    if (id === 'page3') {
        renderUserReports();
        setTimeout(() => initializeReportMap(), 100);
    }
    if (id === 'page4') {
        renderAllReports();
        updateCharts();
    }
    // We've added this new check to load the staff dashboard content
    if (id === 'fieldStaffDashboard') {
        renderFieldStaffDashboard();
    }
}

// --------------------- Google Sign-in + Supabase auth exchange ---------------------
let currentUserEmail = null;
let currentUserId = null;

function decodeJwt(token){
  try{
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c=>'%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
  } catch(e) { return null; }
}

async function handleCredentialResponse(response){
  const payload = decodeJwt(response.credential);
  if(!payload || !payload.email){ showStatusMessage(translations[currentLang].signInFailedAlert, 'error'); return; }

  try {
    await supabaseClient.auth.signInWithIdToken({ provider: 'google', token: response.credential }).catch(e=>console.warn(e));
    const { data: sessData } = await supabaseClient.auth.getSession();
    const supUser = sessData?.session?.user;
    currentUserEmail = supUser?.email ?? payload.email;
    currentUserId = supUser?.id ?? null;
    localStorage.setItem('civic_current_user', currentUserEmail);
    if (currentUserId) localStorage.setItem('civic_user_id', currentUserId);
    gotoPage('page3');
  } catch (err) {
    console.error(err);
    showStatusMessage(translations[currentLang].signInErrorAlert, 'error');
  }
}

supabaseClient.auth.onAuthStateChange((event, session) => {
  const user = session?.user ?? null;
  if(user) {
    currentUserEmail = user.email;
    currentUserId = user.id;
    localStorage.setItem('civic_current_user', currentUserEmail);
    localStorage.setItem('civic_user_id', currentUserId);
  } else {
    currentUserEmail = null;
    currentUserId = null;
    localStorage.removeItem('civic_current_user');
    localStorage.removeItem('civic_user_id');
  }
});

// --------------------- Admin Login ---------------------
async function adminLogin(){
  const id = document.getElementById('adminId').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const err = document.getElementById('adminError');

  if (id === 'civic01') {
    try {
      const email = 'civic01@yourdomain.com';
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;
      err.classList.add('hidden');
      document.getElementById('adminId').value = '';
      document.getElementById('adminPass').value = '';
      gotoPage('page4');
    } catch (e) {
      console.error(e);
      err.classList.remove('hidden');
    }
  } else {
    err.classList.remove('hidden');
  }
}
async function getEmbedding(text) {
    // --- IMPORTANT: Replace with your actual Gemini API key ---
    const API_KEY = 'AIzaSyCEASQob96dMkeZO5HCzK8Xup65uhYAJ6Q';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key=${API_KEY}`;

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: "models/text-embedding-004", content: { parts: [{ text }] } })
        });
        if (!response.ok) throw new Error("Embedding API request failed");
        const data = await response.json();
        return data.embedding.values;
    } catch (error) {
        console.error("Failed to generate embedding:", error);
        showStatusMessage('Could not analyze report text.', 'error');
        return null;
    }
}
// --------------------- Toggle Password Visibility ---------------------
function togglePasswordVisibility() {
  const passInput = document.getElementById('adminPass');
  const toggleBtn = document.querySelector('.password-toggle-btn');
  if (passInput.type === 'password') {
    passInput.type = 'text';
    toggleBtn.textContent = '🙈';
  } else {
    passInput.type = 'password';
    toggleBtn.textContent = '👁';
  }
}

// --------------------- Media Capture ---------------------
let camStream=null, vidRecorder=null, vidChunks=[], audRecorder=null, audChunks=[];

const imgVideo=document.getElementById('imgVideo');
const imgCanvas=document.getElementById('imgCanvas');
const imgPreview=document.getElementById('imgPreview');
const removeImgBtn=document.getElementById('removeImgBtn');

document.getElementById('startCamBtn').onclick=async()=>{
  try {
    camStream=await navigator.mediaDevices.getUserMedia({video:true});
    imgVideo.srcObject=camStream;
    imgVideo.classList.remove('hidden');
    document.getElementById('imgCamControls').classList.remove('hidden');
  } catch (error) {
    console.error("Error accessing camera:", error);
    showStatusMessage(translations[currentLang].cameraErrorAlert, 'error');
  }
};
document.getElementById('takePhotoBtn').onclick=()=>{
  imgCanvas.width=imgVideo.videoWidth; imgCanvas.height=imgVideo.videoHeight;
  imgCanvas.getContext('2d').drawImage(imgVideo,0,0);
  imgPreview.src=imgCanvas.toDataURL('image/png'); imgPreview.classList.remove('hidden');
  removeImgBtn.classList.remove('hidden');
};
document.getElementById('stopCamBtn').onclick=()=>{
  if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;}
  imgVideo.classList.add('hidden'); document.getElementById('imgCamControls').classList.add('hidden');
};
removeImgBtn.onclick=()=>{imgPreview.classList.add('hidden'); removeImgBtn.classList.add('hidden');};

const vidPreview=document.getElementById('vidPreview');
const removeVidBtn=document.getElementById('removeVidBtn');

document.getElementById('startVidRec').onclick=async()=>{
  try {
    const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    vidRecorder=new MediaRecorder(stream); vidChunks=[];
    vidRecorder.ondataavailable=e=>vidChunks.push(e.data);
    vidRecorder.onstop=()=>{vidPreview.src=URL.createObjectURL(new Blob(vidChunks,{type:'video/webm'})); vidPreview.classList.remove('hidden'); removeVidBtn.classList.remove('hidden');};
    vidRecorder.start();
    document.getElementById('stopVidRec').classList.remove('hidden'); document.getElementById('startVidRec').classList.add('hidden');
  } catch (error) {
    console.error("Error accessing video recorder:", error);
    showStatusMessage(translations[currentLang].videoRecorderErrorAlert, 'error');
  }
};

document.getElementById('stopVidRec').onclick=()=>{ if(vidRecorder){vidRecorder.stop(); vidRecorder=null;} document.getElementById('stopVidRec').classList.add('hidden'); document.getElementById('startVidRec').classList.remove('hidden'); };
removeVidBtn.onclick=()=>{vidPreview.classList.add('hidden'); removeVidBtn.classList.add('hidden');};

const audPreview=document.getElementById('audPreview');
const removeAudBtn=document.getElementById('removeAudBtn');

document.getElementById('startAudRec').onclick=async()=>{
  try {
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    audRecorder=new MediaRecorder(stream); audChunks=[];
    audRecorder.ondataavailable=e=>audChunks.push(e.data);
    audRecorder.onstop=()=>{audPreview.src=URL.createObjectURL(new Blob(audChunks,{type:'audio/webm'})); audPreview.classList.remove('hidden'); removeAudBtn.classList.remove('hidden');};
    audRecorder.start();
    document.getElementById('stopAudRec').classList.add('hidden'); document.getElementById('startAudRec').classList.remove('hidden');
  } catch (error) {
    console.error("Error accessing audio recorder:", error);
    showStatusMessage(translations[currentLang].audioRecorderErrorAlert, 'error');
  }
};

document.getElementById('stopAudRec').onclick=()=>{ if(audRecorder){audRecorder.stop(); audRecorder=null;} document.getElementById('stopAudRec').classList.add('hidden'); document.getElementById('startAudRec').classList.remove('hidden'); };
removeAudBtn.onclick=()=>{audPreview.classList.add('hidden'); removeAudBtn.classList.add('hidden');};

// --------------------- Submit, Render, and other functions... ---------------------
function showStatusMessage(message, type = 'success', duration = 3000) {
    const statusMsg = document.getElementById('statusMessage');
    statusMsg.textContent = message;
    statusMsg.className = `status-message show ${type}`;
    setTimeout(() => {
        statusMsg.classList.remove('show');
    }, duration);
}
// DELETE your old submitReport function and REPLACE it with this one.
async function submitReport() {
    const current = localStorage.getItem('civic_current_user') || currentUserEmail;
    const userId = localStorage.getItem('civic_user_id') || currentUserId;

    if (!current) {
        showStatusMessage(translations[currentLang].signInFirstAlert, 'error');
        gotoPage('userLogin');
        return;
    }
    const desc = document.getElementById('issueDesc').value.trim();
    const cat = document.getElementById('issueCat').value;
    const loc = document.getElementById('locationTxt').value.trim();

    if (!desc || !cat || !loc || !selectedCoords) {
        showStatusMessage(translations[currentLang].fillRequiredFieldsAlert, 'error');
        return;
    }

    // ===== NEW AI DUPLICATE DETECTION LOGIC STARTS HERE =====
    showStatusMessage('Analyzing text and checking for duplicates...', 'success');

    const embedding = await getEmbedding(desc);
    if (!embedding) return; // Stop if AI embedding failed

    try {
        const { data: potentialDuplicates, error } = await supabaseClient.rpc('find_similar_reports', {
            query_embedding: embedding,
            lat_val: selectedCoords.lat,
            lng_val: selectedCoords.lng,
            match_threshold: 0.85, // How similar text must be (85%)
            distance_meters: 100   // Search within a 100-meter radius
        });

        if (error) throw error;

        if (potentialDuplicates && potentialDuplicates.length > 0) {
            const firstMatch = potentialDuplicates[0];
            const confirmationMessage = `This looks similar to an existing report:\n\nCategory: ${firstMatch.cat}\nDescription: "${firstMatch.desc}"\n\nIs this a new issue?`;
           
            // For the hackathon, a simple `confirm` dialog is perfect.
            // It will pop up with an "OK" and "Cancel" button.
            if (!confirm(confirmationMessage)) {
                showStatusMessage('Submission cancelled. Thank you for checking!', 'success');
                return; // Stop the function if user clicks "Cancel".
            }
        }
    } catch(e) {
        console.error("Duplicate check failed:", e);
        showStatusMessage('Could not check for duplicates, proceeding with submission.', 'error');
    }
    // ===== NEW AI DUPLICATE DETECTION LOGIC ENDS HERE =====

    // If the code reaches here, it's a new issue. Proceed with upload.
    let img_path = null, vid_path = null, aud_path = null;
    try {
        if (!imgPreview.classList.contains('hidden')) {
            const imgFile = dataURLtoFile(imgPreview.src, `report_${Date.now()}_image.png`);
            img_path = `images/${userId}/${Date.now()}_image.png`;
            await uploadFileToBucket(img_path, imgFile);
        } else if (imgUpload.files.length > 0) {
            img_path = `images/${userId}/${Date.now()}_${imgUpload.files[0].name}`;
            await uploadFileToBucket(img_path, imgUpload.files[0]);
        }
        // (Your other video/audio upload logic would go here)
    } catch (e) {
        console.error('File upload failed', e);
        showStatusMessage('File upload failed: ' + (e.message || e), 'error');
        return;
    }

    try {
        const { error } = await supabaseClient.from('reports').insert([{
            user_email: current,
            desc,
            cat,
            location: loc,
            lat: selectedCoords ? selectedCoords.lat : null,
            lng: selectedCoords ? selectedCoords.lng : null,
            img_url: img_path,
            vid_url: vid_path,
            aud_url: aud_path,
            status: 'Submitted',
            description_embedding: embedding // <-- CRITICAL: Save the AI embedding!
        }]);
        if (error) throw error;

        // Reset the form after successful submission
        document.getElementById('issueDesc').value = '';
        document.getElementById('issueCat').value = '';
        document.getElementById('locationTxt').value = '';
        document.getElementById('locationSearch').value = '';
        selectedCoords = null;
        if (marker) { marker.setLatLng([20.5937, 78.9629]); }
        imgPreview.classList.add('hidden');
        removeImgBtn.classList.add('hidden');
        document.getElementById('imgUpload').value = '';

        showStatusMessage(translations[currentLang].reportSuccessMsg, 'success');
        renderUserReports();
    } catch (e) {
        console.error('DB insert failed', e);
        showStatusMessage(translations[currentLang].saveReportFailedAlert + (e.message || e), 'error');
    }
}


async function submitRating(reportId, rating) {
    try {
        const { error } = await supabaseClient
            .from('reports')
            .update({ rating: rating })
            .eq('id', reportId);
        if (error) throw error;
        showStatusMessage('Thank you for your feedback!', 'success');
        renderUserReports();
    } catch (e) {
        showStatusMessage('Could not submit rating. Please try again.', 'error');
        console.error('Rating submission failed', e);
    }
}
async function renderUserReports(){
  const reportsList = document.getElementById('userReports');
  reportsList.innerHTML = `<p class="small">${translations[currentLang].loadingMessage}</p>`;
  const current = localStorage.getItem('civic_current_user') || currentUserEmail;
  if(!current){ reportsList.innerHTML = `<p class="small">${translations[currentLang].signInToViewReports}</p>`; return; }

  try {
    let { data: rows, error } = await supabaseClient.from('reports').select('*').eq('user_email', current);
    if(error) throw error;

    const sortBy = document.getElementById('sortUserReports').value;
    if (sortBy === 'status') {
        rows.sort((a, b) => a.status.localeCompare(b.status));
    } else if (sortBy === 'category') {
        rows.sort((a, b) => a.cat.localeCompare(b.cat));
    } else if (sortBy === 'dateAsc') {
        rows.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    } else { // dateDesc is default
        rows.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }

    reportsList.innerHTML = '';
    if (rows.length === 0) {
        reportsList.innerHTML = `<p class="small">You have not submitted any reports yet.</p>`;
        return;
    }
    for (const r of rows){
        let mediaHtml = '<div style="display:flex; gap:10px; flex-wrap:wrap;">';
        if (r.img_url) {
            mediaHtml += `<div><p class="small"><b>Your Submission (Before):</b></p><img src="${getPublicUrlForPath(r.img_url)}" class="preview" style="max-height:150px;"></div>`;
        }
        if (r.resolution_image_url) {
            mediaHtml += `<div><p class="small"><b>Resolution Proof (After):</b></p><img src="${getPublicUrlForPath(r.resolution_image_url)}" class="preview" style="max-height:150px;"></div>`;
        }
        mediaHtml += '</div>';
        if (r.vid_url) mediaHtml += `<div style="margin-top:8px"><video src="${getPublicUrlForPath(r.vid_url)}" controls class="preview" style="max-height:150px;"></video></div>`;
        if (r.aud_url) mediaHtml += `<div style="margin-top:8px"><audio src="${getPublicUrlForPath(r.aud_url)}" controls class="preview"></audio></div>`;

      let ratingHtml = '';
      if (r.status === 'Resolved' && !r.rating) {
        ratingHtml = `
          <div style="margin-top:10px;">
            <p class="small">Rate the resolution:</p>
            <div class="rating-stars" style="font-size:24px; cursor:pointer; color:#ffc107;">
              <span onclick="submitRating('${r.id}', 1)">★</span>
              <span onclick="submitRating('${r.id}', 2)">★</span>
              <span onclick="submitRating('${r.id}', 3)">★</span>
              <span onclick="submitRating('${r.id}', 4)">★</span>
              <span onclick="submitRating('${r.id}', 5)">★</span>
            </div>
          </div>`;
      } else if (r.rating) {
        ratingHtml = `<p class="small" style="margin-top:10px;">You rated: ${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</p>`;
      }

      const inner = `
        <div class="report">
          <p><b>${escapeHtml(r.cat)}</b> - ${escapeHtml(r.desc)}</p>
          <p class="small"> ${escapeHtml(r.location || '')}</p>
          ${mediaHtml}
          <p class="small">${translations[currentLang].statusLabel}: <b>${escapeHtml(translations[currentLang][`status${r.status.replace(/\s/g, '')}`])}</b></p>
          ${ratingHtml}
        </div>`;
      reportsList.innerHTML += inner;
    }
  } catch(e){
    console.error(e);
    reportsList.innerHTML = `<p class="small error">${translations[currentLang].failedToLoadReports}</p>`;
  }
}
   
async function renderAllReports() {
    const reportsList = document.getElementById('allReports');
    reportsList.innerHTML = `<p class="small">${translations[currentLang].loadingMessage}</p>`;
    try {
        let { data: rows, error } = await supabaseClient.from('reports').select('*');
        if (error) throw error;
       
        const filterBy = document.getElementById('filterAdminReports').value;
        if (filterBy !== 'all') {
            rows = rows.filter(r => r.status === filterBy);
        }

        const sortBy = document.getElementById('sortAdminReports').value;
        const priorityOrder = { "Electricity": 1, "Water": 1, "Sanitation": 2, "Road": 3, "Streetlight": 3 };
       
        if (sortBy === 'priority') {
            rows.sort((a, b) => {
                const priorityA = priorityOrder[a.cat] || 99;
                const priorityB = priorityOrder[b.cat] || 99;
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                return new Date(b.created_at) - new Date(a.created_at);
            });
        } else if (sortBy === 'dateDesc') {
            rows.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortBy === 'status') {
            rows.sort((a, b) => a.status.localeCompare(b.status));
        } else if (sortBy === 'category') {
            rows.sort((a, b) => a.cat.localeCompare(b.cat));
        }

        if (rows.length === 0) {
            reportsList.innerHTML = `<p class="small">No reports match the selected criteria.</p>`;
            return;
        }

        let allReportsHtml = '';
        for (const r of rows) {
            let mediaHtml = '<div style="display:flex; gap:10px; flex-wrap:wrap;">';
            if (r.img_url) mediaHtml += `<div><p class="small"><b>Before:</b></p><img src="${getPublicUrlForPath(r.img_url)}" class="preview" style="max-height:150px;"></div>`;
            if (r.resolution_image_url) {
                mediaHtml += `<div><p class="small"><b>After (Proof):</b></p><img src="${getPublicUrlForPath(r.resolution_image_url)}" class="preview" style="max-height:150px;"></div>`;
            }
            mediaHtml += '</div>';
            if (r.vid_url) mediaHtml += `<div style="margin-top:8px"><video src="${getPublicUrlForPath(r.vid_url)}" controls class="preview" style="max-height:150px;"></video></div>`;
            if (r.aud_url) mediaHtml += `<div style="margin-top:8px"><audio src="${getPublicUrlForPath(r.aud_url)}" controls class="preview"></audio></div>`;

            const proofUploadHtml = `
              <div class="upload-row" style="margin-top:10px;">
                <input type="file" id="proofUpload-${r.id}" accept="image/*" style="width:auto; flex-grow:1;">
                <button class="btn" style="width:auto;" onclick="uploadResolutionImage('${r.id}')">Upload Proof</button>
              </div>
            `;
            const priorityClass = priorityOrder[r.cat] === 1 ? 'high' : priorityOrder[r.cat] === 2 ? 'medium' : 'low';
            const priorityText = priorityOrder[r.cat] === 1 ? 'High Priority' : priorityOrder[r.cat] === 2 ? 'Medium Priority' : 'Low Priority';

            const inner = `
                <div class="report">
                    <span class="priority-tag ${priorityClass}">${priorityText}</span>
                    <p><b>${escapeHtml(r.cat)}</b> - ${escapeHtml(r.desc)}</p>
                    <p class="small">Location: ${escapeHtml(r.location || 'N/A')}</p>
                    ${r.lat && r.lng ? `<div id="map-${r.id}" class="map-container" style="height: 200px; z-index: 0;"></div>` : ''}
                    ${mediaHtml}
                    ${proofUploadHtml}
                    <p class="small" style="margin-top:10px;">${translations[currentLang].statusLabel}: <b>${escapeHtml(translations[currentLang][`status${r.status.replace(/\s/g, '')}`])}</b></p>
                    <div class="controls" style="margin-top:8px; flex-wrap:wrap;">
                        <button class="btn" style="background-color: #28a745;" onclick="adminUpdate('${r.id}','Accepted')">${translations[currentLang].acceptBtn}</button>
                        <button class="btn" style="background-color: #ffc107; color: #333;" onclick="adminUpdate('${r.id}','In Progress')">${translations[currentLang].inProgressBtn}</button>
                        <button class="btn" style="background-color: #17a2b8;" onclick="adminUpdate('${r.id}','Resolved')">${translations[currentLang].resolvedBtn}</button>
                        <button class="btn btn-danger" onclick="adminDelete('${r.id}','${r.img_url || ''}','${r.vid_url || ''}','${r.aud_url || ''}')">${translations[currentLang].deleteBtn}</button>
                    </div>
                </div>`;
            allReportsHtml += inner;
        }
        reportsList.innerHTML = allReportsHtml;
        for (const r of rows) {
            if (r.lat && r.lng) {
                const reportMap = L.map(`map-${r.id}`, { scrollWheelZoom: false, dragging: false, zoomControl: false }).setView([r.lat, r.lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(reportMap);
                L.marker([r.lat, r.lng]).addTo(reportMap);
            }
        }
    } catch (e) {
        console.error(e);
        reportsList.innerHTML = `<p class="small error">${translations[currentLang].failedToLoadReports}</p>`;
    }
}
         
async function adminUpdate(reportId,status){
  try {
    const { error } = await supabaseClient.from('reports').update({ status }).eq('id', reportId);
    if (error) throw error;
    showStatusMessage('Report updated successfully!', 'success');
    renderAllReports(); updateCharts();
  } catch(e) {
    showStatusMessage(translations[currentLang].updateFailedAlert + (e.message || e), 'error');
  }
}

async function uploadResolutionImage(reportId) {
    const fileInput = document.getElementById(`proofUpload-${reportId}`);
    const file = fileInput.files[0];

    if (!file) {
        showStatusMessage("Please select an image file to upload.", 'error');
        return;
    }

    try {
        const filePath = `resolutions/${reportId}/${Date.now()}_${file.name}`;
        await uploadFileToBucket(filePath, file);

        const { error } = await supabaseClient
            .from('reports')
            .update({ resolution_image_url: filePath })
            .eq('id', reportId);

        if (error) throw error;

        showStatusMessage('Proof of work uploaded successfully!', 'success');
        renderAllReports();
    } catch (e) {
        showStatusMessage('File upload failed. Please try again.', 'error');
        console.error('Resolution image upload failed:', e);
    }
}

async function adminDelete(reportId, imgPath, vidPath, audPath){
  if(!confirm(translations[currentLang].deleteConfirmation)) return;
  try {
    const pathsToRemove = [];
    if(imgPath) pathsToRemove.push(imgPath);
    if(vidPath) pathsToRemove.push(vidPath);
    if(audPath) pathsToRemove.push(audPath);
    if(pathsToRemove.length){
      const { error: rmErr } = await supabaseClient.storage.from('reports').remove(pathsToRemove);
      if(rmErr) console.warn('could not remove some files:', rmErr);
    }
    const { error } = await supabaseClient.from('reports').delete().eq('id', reportId);
    if(error) throw error;
    showStatusMessage('Report deleted successfully!', 'success');
    renderAllReports(); updateCharts();
  } catch(e){
    showStatusMessage(translations[currentLang].deleteFailedAlert + (e.message||e), 'error');
  }
}

let chartObj=null;
async function updateCharts(){
  try {
    const { data: rows, error } = await supabaseClient.from('reports').select('status');
    if(error) throw error;
    const counts={'Submitted':0,'Accepted':0,'In Progress':0,'Resolved':0};
    rows.forEach(r=>{ if(counts[r.status]!==undefined) counts[r.status]++; });
    const ctx=document.getElementById('statusChart').getContext('2d');
    const data={labels:Object.keys(counts).map(key => translations[currentLang][`status${key.replace(/\s/g, '')}`]),datasets:[{label:translations[currentLang].reportsCountLabel,data:Object.values(counts),backgroundColor:['#6c757d','#28a745','#ffc107','#17a2b8']}]};
    if(chartObj) chartObj.destroy();
    chartObj=new Chart(ctx,{type:'bar',data:data,options:{responsive:true, plugins:{legend:{display:false}}, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }}});
  } catch(e){ console.error('charts', e); }
}

async function logoutUser(){ await supabaseClient.auth.signOut(); localStorage.removeItem('civic_current_user'); localStorage.removeItem('civic_user_id'); currentUserEmail=null; currentUserId=null; gotoPage('userLogin'); }

function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

const translations = {
  en: {
    portalTitle: 'Civic Portal',
    roleQuestion: ' Who are you?',
    roleInstruction: 'Choose role to continue',
    userButton: 'I am a User',
    adminButton: 'I am an Admin',
    userLoginTitle: ' Sign in with Google',
    userLoginInstruction: "After signing in you'll be taken to the user portal",
    backButton: '← Back',
    adminLoginTitle: ' Admin Login',
    adminIdPlaceholder: 'Admin ID',
    adminPassPlaceholder: 'Password',
    loginButton: 'Login',
    cancelButton: 'Cancel',
    adminLoginError: ' Incorrect ID or Password',
    reportIssueTitle: ' Report an Issue',
    issueDescPlaceholder: 'Describe the issue...',
    selectCategoryPlaceholder: 'Select category',
    catElectricity: 'Electricity',
    catWater: 'Water',
    catStreetlight: 'Streetlight',
    catRoad: 'Road',
    catSanitation: 'Sanitation',
    locationLabel: ' Problem location',
    locationPlaceholder: 'Pin on the map to enter location',
    searchLocationBtn: 'Search',
    imageLabel: ' Image (upload or capture)',
    startCamBtn: 'Start Camera',
    removeImageBtn: 'Remove Image',
    takePhotoBtn: 'Take Photo',
    stopCamBtn: 'Stop Camera',
    videoLabel: ' Video (upload or record)',
    startVidRec: 'Start Recording',
    stopVidRec: 'Stop Recording',
    removeVidBtn: 'Remove Video',
    audioLabel: ' Audio (upload or record)',
    startAudRec: 'Start Recording',
    stopAudRec: 'Stop Recording',
    removeAudBtn: 'Remove Audio',
    submitReportBtn: 'Submit Report',
    logoutBtn: 'Logout',
    reportSuccessMsg: ' Report submitted successfully!',
    myReportsTitle: ' My Reports',
    adminDashboardTitle: ' Admin Dashboard',
    analyticsTitle: ' Analytics',
    backToRoleBtn: 'Back to Role Select',
    loadingMessage: 'Loading...',
    signInToViewReports: 'Sign in to see your reports',
    statusLabel: 'Status',
    acceptBtn: 'Accept',
    inProgressBtn: 'In Progress',
    resolvedBtn: 'Resolved',
    deleteBtn: 'Delete',
    deleteConfirmation: 'Are you sure you want to delete this report?',
    reportsCountLabel: 'Reports Count',
    signInFailedAlert: 'Google sign-in failed.',
    signInErrorAlert: 'Sign-in error',
    cameraErrorAlert: 'Could not access camera. Please check permissions.',
    videoRecorderErrorAlert: 'Could not access camera/microphone. Please check permissions.',
    audioRecorderErrorAlert: 'Could not access microphone. Please check permissions.',
    signInFirstAlert: 'You must be signed in to submit a report.',
    fillRequiredFieldsAlert: 'Please fill in the description, category, and location.',
    imageUploadFailedAlert: 'Image upload failed: ',
    videoUploadFailedAlert: 'Video upload failed: ',
    audioUploadFailedAlert: 'Audio upload failed: ',
    saveReportFailedAlert: 'Could not save report: ',
    failedToLoadReports: 'Failed to load reports.',
    updateFailedAlert: 'Update failed: ',
    deleteFailedAlert: 'Delete failed: ',
    statusSubmitted: 'Submitted',
    statusAccepted: 'Accepted',
    statusInProgress: 'In Progress',
    statusResolved: 'Resolved'
  },
  hi: {
    portalTitle: 'नागरिक पोर्टल',
    roleQuestion: ' आप कौन हैं?',
    roleInstruction: 'जारी रखने के लिए भूमिका चुनें',
    userButton: 'मैं एक उपयोगकर्ता हूँ',
    adminButton: 'मैं एक प्रशासक हूँ',
    userLoginTitle: ' गूगल से साइन इन करें',
    userLoginInstruction: 'साइन इन करने के बाद आपको उपयोगकर्ता पोर्टल पर ले जाया जाएगा',
    backButton: '← पीछे',
    adminLoginTitle: ' प्रशासक लॉगिन',
    adminIdPlaceholder: 'प्रशासक आईडी',
    adminPassPlaceholder: 'पासवर्ड',
    loginButton: 'लॉगिन',
    cancelButton: 'रद्द करें',
    adminLoginError: ' गलत आईडी या पासवर्ड',
    reportIssueTitle: ' एक समस्या की रिपोर्ट करें',
    issueDescPlaceholder: 'समस्या का वर्णन करें...',
    selectCategoryPlaceholder: 'श्रेणी चुनें',
    catElectricity: 'बिजली',
    catWater: 'पानी',
    catStreetlight: 'स्ट्रीटलाइट',
    catRoad: 'सड़क',
    catSanitation: 'स्वच्छता',
    locationLabel: ' समस्या का स्थान',
    locationPlaceholder: 'स्थान दर्ज करने के लिए मानचित्र पर पिन करें',
    searchLocationBtn: 'खोजें',
    imageLabel: ' छवि (अपलोड या कैप्चर करें)',
    startCamBtn: 'कैमरा शुरू करें',
    removeImageBtn: 'छवि हटाएँ',
    takePhotoBtn: 'फ़ोटो लें',
    stopCamBtn: 'कैमरा बंद करें',
    videoLabel: ' वीडियो (अपलोड या रिकॉर्ड करें)',
    startVidRec: 'रिकॉर्डिंग शुरू करें',
    stopVidRec: 'रिकॉर्डिंग बंद करें',
    removeVidBtn: 'वीडियो हटाएँ',
    audioLabel: ' ऑडिओ (अपलोड या रिकॉर्ड करें)',
    startAudRec: 'रिकॉर्डिंग शुरू करें',
    stopAudRec: 'रिकॉर्डिंग बंद करें',
    removeAudBtn: 'ऑडिओ हटाएँ',
    submitReportBtn: 'रिपोर्ट सबमिट करें',
    logoutBtn: 'लॉगआउट',
    reportSuccessMsg: ' रिपोर्ट सफलतापूर्वक सबमिट हो गई!',
    myReportsTitle: ' मेरी रिपोर्टें',
    adminDashboardTitle: ' व्यवस्थापक डैशबोर्ड',
    analyticsTitle: ' विश्लेषण',
    backToRoleBtn: 'भूमिका चयन पर वापस जाएँ',
    loadingMessage: 'लोड हो रहा है...',
    signInToViewReports: 'अपनी रिपोर्ट देखने के लिए साइन इन करें',
    statusLabel: 'स्थिति',
    acceptBtn: 'स्वीकार करें',
    inProgressBtn: 'प्रगती में है',
    resolvedBtn: 'हल हो गया',
    deleteBtn: 'हटाएँ',
    deleteConfirmation: 'क्या आप वाकई इस रिपोर्ट को हटाना चाहते हैं?',
    reportsCountLabel: 'रिपोर्टों की संख्या',
    signInFailedAlert: 'गूगल साइन-इन विफल।',
    signInErrorAlert: 'साइन-इन त्रुटि',
    cameraErrorAlert: 'कैमरा तक नहीं पहुँचा जा सका। कृपया अनुमतियाँ जाँचें।',
    videoRecorderErrorAlert: 'कैमरा/माइक्रोफोन तक नहीं पहुँचा जा सका। कृपया अनुमतियाँ जाँचें।',
    audioRecorderErrorAlert: 'माइक्रोफोन तक नहीं पहुँचा जा सका। कृपया अनुमतियाँ जाँचें।',
    signInFirstAlert: 'रिपोर्ट सबमिट करने के लिए आपको साइन इन करना होगा।',
    fillRequiredFieldsAlert: 'कृपया विवरण, श्रेणी और स्थान भरें।',
    imageUploadFailedAlert: 'छवि अपलोड विफल: ',
    videoUploadFailedAlert: 'वीडियो अपलोड विफल: ',
    audioUploadFailedAlert: 'ऑडिओ अपलोड विफल: ',
    saveReportFailedAlert: 'रिपोर्ट सहेजी नहीं जा सकी: ',
    failedToLoadReports: 'रिपोर्ट लोड करने में विफल रहा।',
    updateFailedAlert: 'अपडेट विफल: ',
    deleteFailedAlert: 'हटाने में विफल: ',
    statusSubmitted: 'प्रस्तुत',
    statusAccepted: 'स्वीकृत',
    statusInProgress: 'प्रगति में',
    statusResolved: 'हल किया गया'
  },
  mr: {
    portalTitle: 'नागरिक पोर्टल',
    roleQuestion: ' तुम्ही कोण आहात?',
    roleInstruction: 'पुढे जाण्यासाठी भूमिका निवडा',
    userButton: 'मी वापरकर्ता आहे',
    adminButton: 'मी प्रशासक आहे',
    userLoginTitle: ' Google सह साइन इन करा',
    userLoginInstruction: 'साइन इन केल्यानंतर तुम्हाला वापरकर्ता पोर्टलवर नेले जाईल',
    backButton: '← मागे',
    adminLoginTitle: ' ॲडमिन लॉगिन',
    adminIdPlaceholder: 'ॲडमिन आयडी',
    adminPassPlaceholder: 'पासवर्ड',
    loginButton: 'लॉगिन',
    cancelButton: 'रद्द करा',
    adminLoginError: ' चुकीचा आयडी किंवा पासवर्ड',
    reportIssueTitle: ' समस्या नोंदवा',
    issueDescPlaceholder: 'समस्येचे वर्णन करा...',
    selectCategoryPlaceholder: 'श्रेणी निवडा',
    catElectricity: 'वीज',
    catWater: 'पाणी',
    catStreetlight: 'स्ट्रीटलाइट',
    catRoad: 'रस्ता',
    catSanitation: 'स्वच्छता',
    locationLabel: ' समस्येचे स्थान',
    locationPlaceholder: 'स्थान प्रविष्ट करण्यासाठी नकाशावर पिन करा',
    searchLocationBtn: 'शोधा',
    imageLabel: ' प्रतिमा (अपलोड किंवा कॅप्चर करा)',
    startCamBtn: 'कॅमेरा सुरू करा',
    removeImageBtn: 'प्रतिमा काढा',
    takePhotoBtn: 'फोटो घ्या',
    stopCamBtn: 'कॅमेरा बंद करा',
    videoLabel: ' व्हिडिओ (अपलोड किंवा रेकॉर्ड करा)',
    startVidRec: 'रेकॉर्डिंग सुरू करा',
    stopVidRec: 'रेकॉर्डिंग बंद करा',
    removeVidBtn: 'व्हिडिओ काढा',
    audioLabel: ' ऑडिओ (अपलोड किंवा रेकॉर्ड करा)',
    startAudRec: 'रेकॉर्डिंग सुरू करा',
    stopAudRec: 'रेकॉर्डिंग बंद करा',
    removeAudBtn: 'ऑडिओ काढा',
    submitReportBtn: 'रिपोर्ट सबमिट करा',
    logoutBtn: 'लॉगआउट',
    reportSuccessMsg: ' रिपोर्ट यशस्वीरित्या सबमिट झाली!',
    myReportsTitle: ' माझ्या रिपोर्ट',
    adminDashboardTitle: ' ॲडमिन डॅशबोर्ड',
    analyticsTitle: ' विश्लेषण',
    backToRoleBtn: 'भूमिका निवडीवर परत जा',
    loadingMessage: 'लोड होत आहे...',
    signInToViewReports: 'तुमच्या रिपोर्ट पाहण्यासाठी साइन इन करा',
    statusLabel: 'स्थिती',
    acceptBtn: 'स्वीकारा',
    inProgressBtn: 'प्रगतीत आहे',
    resolvedBtn: 'सोडवले',
    deleteBtn: 'काढा',
    deleteConfirmation: 'तुम्हाला खात्री आहे की ही रिपोर्ट काढायची आहे?',
    reportsCountLabel: 'रिपोर्टची संख्या',
    signInFailedAlert: 'Google साइन-इन अयशस्वी.',
    signInErrorAlert: 'साइन-इन त्रुटी',
    cameraErrorAlert: 'कॅमेऱ्यात प्रवेश करता आला नाही. कृपया परवानग्या तपासा.',
    videoRecorderErrorAlert: 'कॅमेरा/मायक्रोफोनमध्ये प्रवेश करता आला नाही. कृपया परवानग्या तपासा.',
    audioRecorderErrorAlert: 'मायक्रोफोनमध्ये प्रवेश करता आला नाही. कृपया परवानग्या तपासा.',
    signInFirstAlert: 'रिपोर्ट सबमिट करण्यासाठी तुम्ही साइन इन केलेले असणे आवश्यक आहे.',
    fillRequiredFieldsAlert: 'कृपया वर्णन, श्रेणी आणि स्थान भरा.',
    imageUploadFailedAlert: 'प्रतिमा अपलोड अयशस्वी: ',
    videoUploadFailedAlert: 'व्हिडिओ अपलोड अयशस्वी: ',
    audioUploadFailedAlert: 'ऑडिओ अपलोड अयशस्वी: ',
    saveReportFailedAlert: 'रिपोर्ट सेव्ह करू शकलो नाही: ',
    failedToLoadReports: 'रिपोर्ट लोड करण्यात अयशस्वी.',
    updateFailedAlert: 'अपडेट अयशस्वी: ',
    deleteFailedAlert: 'काढणे अयशस्वी: ',
    statusSubmitted: 'सबमिट केले',
    statusAccepted: 'स्वीकृत',
    statusInProgress: 'प्रगतीत',
    statusResolved: 'सोडवले'
  },
  or: {
    portalTitle: 'ସିଭିକ୍ ପୋର୍ଟାଲ୍',
    roleQuestion: ' ଆପଣ କିଏ?',
    roleInstruction: 'ଜାରି ରଖିବାକୁ ଭୂମିକା ବାଛନ୍ତୁ',
    userButton: 'ମୁଁ ଜଣେ ଉପଭୋକ୍ତା',
    adminButton: 'ମୁଁ ଜଣେ ଆଡମିନ୍',
    userLoginTitle: ' ଗୁଗୁଲ୍ ସହିତ ସାଇନ୍ ଇନ୍ କରନ୍ତୁ',
    userLoginInstruction: 'ସାଇନ୍ ଇନ୍ କରିବା ପରେ ଆପଣଙ୍କୁ ଉପଭୋକ୍ତା ପୋର୍ଟାଲ୍ କୁ ନିଆଯିବ',
    backButton: '← ପଛକୁ',
    adminLoginTitle: ' ଆଡମିନ୍ ଲଗ୍ ଇନ୍',
    adminIdPlaceholder: 'ଆଡମିନ୍ ID',
    adminPassPlaceholder: 'ପାସୱାର୍ଡ',
    loginButton: 'ଲଗ୍ ଇନ୍',
    cancelButton: 'ବାତିଲ୍',
    adminLoginError: ' ଭୁଲ୍ ID କିମ୍ବା ପାସୱାର୍ଡ',
    reportIssueTitle: ' ଏକ ସମସ୍ୟା ରିପୋର୍ଟ କରନ୍ତୁ',
    issueDescPlaceholder: 'ସମସ୍ୟା ବର୍ଣ୍ଣନା କରନ୍ତୁ...',
    selectCategoryPlaceholder: 'ବର୍ଗ ବାଛନ୍ତୁ',
    catElectricity: 'ବିଦ୍ୟୁତ୍',
    catWater: 'ପାଣି',
    catStreetlight: 'ଷ୍ଟ୍ରିଟଲାଇଟ୍',
    catRoad: 'ରାସ୍ତା',
    catSanitation: 'ସ୍ୱଚ୍ଛତା',
    locationLabel: ' ସମସ୍ୟା ସ୍ଥାନ',
    locationPlaceholder: 'ସ୍ଥାନ ଦେବା ପାଇଁ ମାନଚିତ୍ର ରେ ପିନ୍ କରନ୍ତୁ',
    searchLocationBtn: 'ଖୋଜନ୍ତୁ',
    imageLabel: ' ଛବି (ଅପଲୋଡ୍ କିମ୍ବା କ୍ୟାପଚର୍)',
    startCamBtn: 'କ୍ୟାମେରା ଆରମ୍ଭ କରନ୍ତୁ',
    removeImageBtn: 'ଛବି ହଟାନ୍ତୁ',
    takePhotoBtn: 'ଫଟୋ ନିଅନ୍ତୁ',
    stopCamBtn: 'କ୍ୟାମେରା ବନ୍ଦ କରନ୍ତୁ',
    videoLabel: ' ଭିଡିଓ (ଅପଲୋଡ୍ କିମ୍ବା ରେକର୍ଡ)',
    startVidRec: 'ରେକର୍ଡିଂ ଆରମ୍ଭ କରନ୍ତୁ',
    stopVidRec: 'ରେକର୍ଡିଂ ବନ୍ଦ କରନ୍ତୁ',
    removeVidBtn: 'ଭିଡିଓ ହଟାନ୍ତୁ',
    audioLabel: ' ଅଡିଓ (ଅପଲୋଡ୍ କିମ୍ବା ରେକର୍ଡ)',
    startAudRec: 'ରେକର୍ଡିଂ ଆରମ୍ଭ କରନ୍ତୁ',
    stopAudRec: 'ରେକର୍ଡିଂ ବନ୍ଦ କରନ୍ତୁ',
    removeAudBtn: 'ଅଡିଓ ହଟାନ୍ତୁ',
    submitReportBtn: 'ରିପୋର୍ଟ ଦାଖଲ କରନ୍ତୁ',
    logoutBtn: 'ଲଗ୍ ଆଉଟ୍',
    reportSuccessMsg: ' ରିପୋର୍ଟ ସଫଳତାର ସହିତ ଦାଖଲ ହୋଇଛି!',
    myReportsTitle: ' ମୋର ରିପୋର୍ଟଗୁଡ଼ିକ',
    adminDashboardTitle: ' ଆଡମିନ୍ ଡ୍ୟାସବୋର୍ଡ',
    analyticsTitle: ' ବିଶ୍ଳେଷଣ',
    backToRoleBtn: 'ଭୂମିକା ଚୟନକୁ ଫେରନ୍ତୁ',
    loadingMessage: 'ଲୋଡ୍ ହେଉଛି...',
    signInToViewReports: 'ଆପଣଙ୍କ ରିପୋର୍ଟଗୁଡ଼ିକ ଦେଖିବାକୁ ସାଇନ୍ ଇନ୍ କରନ୍ତୁ',
    statusLabel: 'ସ୍ଥିତି',
    acceptBtn: 'ଗ୍ରହଣ କରନ୍ତୁ',
    inProgressBtn: 'ପ୍ରଗତିରେ',
    resolvedBtn: 'ସମାଧାନ ହୋଇଛି',
    deleteBtn: 'ହଟାନ୍ତୁ',
    deleteConfirmation: 'ଆପଣ ଏହି ରିପୋର୍ଟକୁ ହଟାଇବାକୁ ନିଶ୍ଚିତ କି?',
    reportsCountLabel: 'ରିପୋର୍ଟଗୁଡ଼ିକର ସଂଖ୍ୟା',
    signInFailedAlert: 'ଗୁଗୁଲ୍ ସାଇନ୍ ଇନ୍ ବିଫଳ ହେଲା।',
    signInErrorAlert: 'ସାଇନ୍ ଇନ୍ ତ୍ରୁଟି',
    cameraErrorAlert: 'କ୍ୟାମେରାକୁ ପ୍ରବେଶ କରିପାରିଲୁ ନାହିଁ। ଦୟାକରି ଅନୁମତିଗୁଡ଼ିକୁ ଯାଞ୍ଚ କରନ୍ତୁ।',
    videoRecorderErrorAlert: 'କ୍ୟାମେରା/ମାଇକ୍ରୋଫୋନକୁ ପ୍ରବେଶ କରିପାରିଲୁ ନାହିଁ। ଦୟାକରି ଅନୁମତିଗୁଡ଼ିକୁ ଯାଞ୍ଚ କରନ୍ତୁ।',
    audioRecorderErrorAlert: 'ମାଇକ୍ରୋଫୋନକୁ ପ୍ରବେଶ କରିପାରିଲୁ ନାହିଁ। ଦୟାକରି ଅନୁମତିଗୁଡ଼ିକୁ ଯାଞ୍ଚ କରନ୍ତୁ।',
    signInFirstAlert: 'ରିପୋର୍ଟ ଦାଖଲ କରିବା ପାଇଁ ଆପଣ ସାଇନ୍ ଇନ୍ କରିବା ଜରୁରୀ।',
    fillRequiredFieldsAlert: 'ଦୟାକରି ବର୍ଣ୍ଣନା, ବର୍ଗ ଏବଂ ସ୍ଥାନ ଭରନ୍ତୁ।',
    imageUploadFailedAlert: 'ଛବି ଅପଲୋଡ୍ ବିଫଳ ହେଲା: ',
    videoUploadFailedAlert: 'ଭିଡିଓ ଅପଲୋଡ୍ ବିଫଳ ହେଲା: ',
    audioUploadFailedAlert: 'ଅଡିଓ ଅପଲୋଡ୍ ବିଫଳ ହେଲା: ',
    saveReportFailedAlert: 'ରିପୋର୍ଟ ସେଭ୍ କରିପାରିଲୁ ନାହିଁ: ',
    failedToLoadReports: 'ରିପୋର୍ଟଗୁଡ଼ିକ ଲୋଡ୍ କରିବାରେ ବିଫଳ ହେଲା।',
    updateFailedAlert: 'ଅପଡେଟ୍ ବିଫଳ ହେଲା: ',
    deleteFailedAlert: 'ହଟାଇବା ବିଫଳ ହେଲା: ',
    statusSubmitted: 'ଦାଖଲ ହୋଇଛି',
    statusAccepted: 'ଗ୍ରହଣ କରାଯାଇଛି',
    statusInProgress: 'ପ୍ରଗତିରେ',
    statusResolved: 'ସମାଧାନ ହୋଇଛି'
},
ur: {
    portalTitle: 'سوِک پورٹل',
    roleQuestion: ' آپ کون ہیں؟',
    roleInstruction: 'جاری رکھنے کے لیے کردار منتخب کریں',
    userButton: 'میں ایک صارف ہوں',
    adminButton: 'میں ایک ایڈمن ہوں',
    userLoginTitle: ' گوگل کے ساتھ سائن ان کریں',
    userLoginInstruction: 'سائن ان کرنے کے بعد آپ کو صارف پورٹل پر لے جایا جائے گا',
    backButton: '← پیچھے',
    adminLoginTitle: ' ایڈمن لاگ ان',
    adminIdPlaceholder: 'ایڈمن ID',
    adminPassPlaceholder: 'پاس ورڈ',
    loginButton: 'لاگ ان',
    cancelButton: 'منسوخ کریں',
    adminLoginError: ' غلط ID یا پاس ورڈ',
    reportIssueTitle: ' ایک مسئلہ رپورٹ کریں',
    issueDescPlaceholder: 'مسئلہ کی تفصیل...',
    selectCategoryPlaceholder: 'زمرہ منتخب کریں',
    catElectricity: 'بجلی',
    catWater: 'پانی',
    catStreetlight: 'اسٹریٹ لائٹ',
    catRoad: 'سڑک',
    catSanitation: 'صفائی',
    locationLabel: ' مسئلہ کا مقام',
    locationPlaceholder: 'مقام درج کرنے کے لیے نقشہ پر پن کریں',
    searchLocationBtn: 'تلاش کریں',
    imageLabel: ' تصویر (اپ لوڈ یا کیپچر)',
    startCamBtn: 'کیمرہ شروع کریں',
    removeImageBtn: 'تصویر ہٹائیں',
    takePhotoBtn: 'تصویر لیں',
    stopCamBtn: 'کیمرہ بند کریں',
    videoLabel: ' ویڈیو (اپ لوڈ یا ریکارڈ)',
    startVidRec: 'ریکارڈنگ شروع کریں',
    stopVidRec: 'ریکارڈنگ بند کریں',
    removeVidBtn: 'ویڈیو ہٹائیں',
    audioLabel: ' آڈیو (اپ لوڈ یا ریکارڈ)',
    startAudRec: 'ریکارڈنگ شروع کریں',
    stopAudRec: 'ریکارڈنگ بند کریں',
    removeAudBtn: 'آڈیو ہٹائیں',
    submitReportBtn: 'رپورٹ جمع کریں',
    logoutBtn: 'لاگ آؤਟ',
    reportSuccessMsg: ' رپورٹ کامیابی سے جمع ہو گئی ہے!',
    myReportsTitle: ' میری رپورٹس',
    adminDashboardTitle: ' ایڈمن ڈیش بورڈ',
    analyticsTitle: ' تجزیات',
    backToRoleBtn: 'کردار کے انتخاب پر واپس جائیں',
    loadingMessage: 'لوڈ ہو رہا ہے...',
    signInToViewReports: 'اپنی رپورٹس دیکھنے کے لیے سائن ان کریں',
    statusLabel: 'حیثیت',
    acceptBtn: 'قبول کریں',
    inProgressBtn: 'ترقی میں ہے',
    resolvedBtn: 'حل ہو گیا',
    deleteBtn: 'حذف کریں',
    deleteConfirmation: 'کیا آپ واقعی اس رپورٹ کو حذف کرنا چاہتے ہیں؟',
    reportsCountLabel: 'رپورٹس کی گنتی',
    signInFailedAlert: 'گوگل سائن ان ناکام ہو گیا۔',
    signInErrorAlert: 'سائن ان کی خرابی',
    cameraErrorAlert: 'کیمرہ تک رسائی نہیں ہو سکی۔ براہ کرم اجازتیں چیک کریں۔',
    videoRecorderErrorAlert: 'کیمرہ/مائیکروفون تک رسائی نہیں ہو سکی۔ براہ کرم اجازتیں چیک کریں۔',
    audioRecorderErrorAlert: 'مائیکروفون تک رسائی نہیں ہو سکی۔ براہ کرم اجازتیں چیک کریں۔',
    signInFirstAlert: 'رپورٹ جمع کرنے کے لیے آپ کو سائن ان کرنا ضروری ہے۔',
    fillRequiredFieldsAlert: 'براہ کرم تفصیل، زمرہ اور مقام پُر کریں۔',
    imageUploadFailedAlert: 'تصویر اپ لوڈ ناکام: ',
    videoUploadFailedAlert: 'ویڈیو اپ لوڈ ناکام: ',
    audioUploadFailedAlert: 'آڈیو اپ لوڈ ناکام: ',
    saveReportFailedAlert: 'رپورٹ محفوظ نہیں ہو سکی: ',
    failedToLoadReports: 'رپورٹس لوڈ کرنے میں ناکام رہا۔',
    updateFailedAlert: 'اپ ڈیٹ ناکام: ',
    deleteFailedAlert: 'حذف ناکام: ',
    statusSubmitted: 'جمع شدہ',
    statusAccepted: 'منظور شدہ',
    statusInProgress: 'ترقی میں',
    statusResolved: 'حل شدہ'
}
};

let currentLang = 'en';

function setLanguage(lang) {
  currentLang = lang;
  document.documentElement.lang = lang;
  document.querySelectorAll('[data-lang]').forEach(element => {
    const key = element.getAttribute('data-lang');
    if (translations[lang] && translations[lang][key]) {
      element.textContent = translations[lang][key];
    }
  });
  document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
    const key = element.getAttribute('data-lang-placeholder');
    if (translations[lang] && translations[lang][key]) {
      element.placeholder = translations[lang][key];
    }
  });
  const categorySelect = document.getElementById('issueCat');
  const categoryOptions = categorySelect.getElementsByTagName('option');
  for (let i = 1; i < categoryOptions.length; i++) {
    const optionKey = categoryOptions[i].getAttribute('data-lang');
    if (translations[lang] && translations[lang][optionKey]) {
        categoryOptions[i].textContent = translations[lang][optionKey];
    }
  }
  if (!document.getElementById('page3').classList.contains('hidden')) renderUserReports();
  if (!document.getElementById('page4').classList.contains('hidden')) { renderAllReports(); updateCharts(); }
}

function toggleTheme() {
    const body = document.body;
    body.classList.toggle('dark-theme');
    const themeToggleBtn = document.getElementById('themeToggle');
    const isDark = body.classList.contains('dark-theme');
    themeToggleBtn.textContent = isDark ? '🌙' : '☀️';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

// Check for saved theme preference on page load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        document.getElementById('themeToggle').textContent = '🌙';
    } else {
        document.body.classList.remove('dark-theme');
        document.getElementById('themeToggle').textContent = '☀️';
    }
});

setLanguage(currentLang);
</script>
</body>
</html>
